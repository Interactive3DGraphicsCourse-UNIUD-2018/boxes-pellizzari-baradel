<html>
	<head>
		<title>Progetto 3D 2018 - with lights and textures</title>
		<style>

		body {
			font-family: Monospace;
			background-color: #71b2cf;
			margin: 0px;
			overflow: hidden;
		}

		canvas {
			width: 100%;
			height: 100%;
		}

		.right {
			position: absolute;
			right: 0px;
			width: 80px;
		}

	</style>

		<script src="lib/three.min.js"></script>
		<script src="lib/stats.min.js"></script>
		<script src="lib/Coordinates.js"></script>
		<script src="lib/OrbitControls.js"></script>
		
		<script src="src/Macchina.js"></script>
		<script src="src/Strada.js"></script>
		<script src="src/Ausiliarie.js"></script>
		<script src="src/Ostacoli.js"></script>
		<script src="src/MovimentoMacchina.js"></script>
		<script src="src/Collisioni.js"></script>
		<script src="src/Animazioni.js"></script>
		<script src="src/PowerUp.js"></script>
	</head>
	<body>
		<div class="right", id="punteggio" > </div>

		<div class="contenitore" id="contenitoreBottone" >
			<button id="bottone" onclick="nuovaPartita()" >Nuova partita</button>
		</div>

		<script>

		document.getElementById("contenitoreBottone").style.display = "none";  // elimino/nascondo l'elemento (bottone di fine partita) dalla scena

		// VARIABILI PER LA CREAZIONE DELLA SCENA
		var scene, camera, renderer, controls, stats, tabellaPunti, punti;
		var pivotMacchina;  // pivot che contiene la macchina e la camera, così si muovono insieme
		var yFineRuote;  // punto sull'asse y in cui iniziano le ruote
		var lunghezzaStrada = 10000;

		// VARIABILI PER LE ANIMAZIONI
		var asteroidi = new Array();
		var contatoreAsteroide = 0;
		var numAsteroide = 0;
		var velocitaDiscesa = 0;
		var mulini = new Array();
		var posizioneZMulini = new Array();
		var contatoreMulini = 0;
		var numMulini = 0;

		// VARIABILI PER IL MOVIMENTO DELLA MACCHINA
		var xDestra, xSinistra;  // possibili valori della posizione x della macchina durante la partita (sulla strada)
		var muoviDx, muoviSx;  // variabili booleane che servono per il movimento della macchina a destra e a sinistra
		var spostamentoMacchinaZ = 0.6;  // quanto velocemente avanza la macchina verso -z
		var spostamentoMacchinaX;  // quanto la macchina si sposta su x alla pressione dei tasti direzionali
		var fasciaPosizioneMacchina = 0;  // quanto lontano si trova la macchina dall'origine
		var offsetMacchinaZ = 1.75;  // distanza fra centro della macchina e fine delle ruote (su z)
		var offsetMacchinaX = 0.75;  // distanza fra centro della macchina e fine della fiancata (su x)

		// VARIABILI CHE SERVONO PER LE COLLISIONI
		gameOver = false; //Quando un ostacolo viene colpito, questa variabile diventa true e il gioco ha termine
		spazioFraOstacoli = 50;
		numeroOstacoli = (lunghezzaStrada/spazioFraOstacoli) -2;  // -2 perchè in posizione 0 e in fondo alla pista non metto ostacoli
		posizioneOstacoli = new Array(); // Array per la gestione delle collisioni, ostacoli[i] = 1 (Destra), -1(Sinistra)
		tipoOstacoli = new Array(); //Array per la gestione delle collisione, indica solo il tipo di ostacolo con le stringhe (es. "asteroide")

		// Variabili per i PowerUp
		numeroPowerUp = 49; //Sono presenti 49 powerUp in pista, uno ogni 4 ostacoli;
		angoloOscillazioneVerticale = 0;

		// Variabili ausiliarie
		var rotazioneAttuale = 0;
		var bottoneInserito = false;
		punteggio = 0;  // variabile per tenere conto dei punti in base alla distanza percorsa
		punteggioBonus = 0;
		punteggioTotale = 0;

		function Start() {
			scene = new THREE.Scene();
			camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 400 );
			pivotMacchina = new THREE.Object3D();

			renderer = new THREE.WebGLRenderer( {antialias: true} );
			renderer.setSize( window.innerWidth, window.innerHeight );
			renderer.setClearColor( 0x71b2cf );
			renderer.setPixelRatio( window.devicePixelRatio );
			renderer.gammaInput = true;
			renderer.gammaOutput = true;
			renderer.shadowMap.enabled = true;
			document.body.appendChild( renderer.domElement );

			camera.position.set(2,2,12);
			camera.lookAt( new THREE.Vector3(0,0,0));
			pivotCamera = new THREE.Object3D();
			pivotCamera.add(camera);

			yFineRuote = inserisciMacchina();
			pivotMacchina.add(pivotCamera);
			scene.add(pivotMacchina);
			scene.fog = new THREE.Fog( 0x71b2cf, 0.1, 400 );

			inserisciStrada();  // inserisco strada con gli ostacoli
			inserisciLuceEmisferica();
			arrayOmini = new Array();
			arrayVelOmini = new Array();
			inserisciOmini();
			inserisciOminiStart();
			inserisciOminiEnd();

			pivotMacchina.position.x = scegliLato("interno");  // posiziono la macchina su uno dei due lati (a caso)
			pivotMacchina.position.z = -(3 + 0.5)/2;  // posiziono la macchina all'inizio della strada (lunghezza macchina + lunghezza ruote)/2

			stats = new Stats();
			stats.domElement.style.position = 'absolute';
			stats.domElement.style.top = '0px';
			document.body.appendChild( stats.domElement );

			// Aggiungo i controlli
			controls = new THREE.OrbitControls( camera );
			controls.enableKeys = false;  // disabilito la tastiera, così posso giocare al minigioco senza spostare la camera quando premo le frecce
			controls.addEventListener( 'change', Render );


			/* Script per la pressione delle chiavi, sono state usate solo le chiavi
			*  dei tasti dirazionali laterali (Destra, Sinistra, A, D);
			*/
			var onKeyDown = function ( event ) {
				switch ( event.keyCode ) {
					// se premo A oppure la freccia sinistra
					case 37: // left
					case 65: // a
						muoviDx = false;
						muoviSx = true;
						break;
					// se premo D oppure la freccia destra
					case 39: // right
					case 68: // d
						muoviSx = false;
						muoviDx = true;
						break;
				}
			};

			document.addEventListener( 'keydown', onKeyDown);

			muoviSx = false;  // inizialmente tutti a false
			muoviDx = false;

			aggiungiPowerUp();
		}  // Start()

		function animaScena(){
			// AGGIORNO IL FUOCO
			aggiornaFuoco(arrFuoco);
			aggiornaOmini();
			aggiornaMeshPowerUp();
			if(!gameOver){
				// ANIMO GLI EVENTUALI ASTEROIDI
				controllaAsteroide();
				// ANIMA MULINO
				controllaMulino();
				// VERIFICO CHE NON CI SIANO COLLISIONI
				controllaCollisioni();
				controllaCollisioniBonus();
				aggiornaBonus();

<<<<<<< HEAD
=======
				console.log("Distanza fine stella: " + powerUpAttivi[0]);
				console.log("Colpi rimanenti: " + powerUpAttivi[1]);
				console.log("Scudo: " + powerUpAttivi[2]);

>>>>>>> a1042dd0309b06404324d82f1a2fdbd24e41cf16
				// CALCOLO LO SPOSTAMENTO CHE DOVREBBE FARE LA MACCHINA
				scegliSpostamentoMacchina(pivotMacchina.position.z);  // in base alla posizione della macchina...
				if(!gameOver){
					pivotMacchina.position.z -= spostamentoMacchinaZ;  // imposto la sua velocità
				}
				// IN BASE AI TASTI PREMUTI VADO AVANTI (se non si verifica il gameOver)
				if(muoviSx){
					muoviMacchinaSx(pivotMacchina);
				}
				if(muoviDx){
					muoviMacchinaDx(pivotMacchina);
				}
				// ALL'ARRIVO, SE VINCO FACCIO RUOTARE LA TELECAMERA ATTORNO ALLA MACCHINA E INSERISCO IL BOTTONE DI NUOVA PARTITA
				if(pivotMacchina.position.z < -10000){
					rotateCamera();
					controllaBottone();
				}
			}else{  // gameOver
				// FACCIO RUOTARE LA TELECAMERA ATTORNO ALLA MACCHINA E INSERISCO IL BOTTONE DI NUOVA PARTITA
				rotateCamera();
				controllaBottone();
			}
			stampaPunteggio();
		}

		// UPDATE E CICLO DI RENDER

		function Update() {
			requestAnimationFrame( Update );
			controls.update();
			stats.update();
			Render();
		}

		function Render() {
			animaScena();
			renderer.render(scene, camera);
		}

		Start();
		Update();

		</script>
	</body>
</html>
